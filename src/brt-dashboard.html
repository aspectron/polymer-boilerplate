<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/brt-panel/brt-panel.html">
<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<!-- Define your custom element -->
<polymer-element name="brt-dashboard-splitter" extends="core-splitter">
    <script type="text/javascript">
        Polymer({
            domReady: function() {
                if (!this.allowOverflow) {
                    if (this.nextElementSibling) {
                        this.nextElementSibling.style.overflow = 'none';
                    };
                    if (this.previousElementSibling) {
                        this.previousElementSibling.style.overflow = 'none';
                    };
                    this.parentNode.style.overflow = 'hidden';
                }
            },
            directionChanged: function() {
                //this.isNext = this.direction === 'right' || this.direction === 'down';
                this.horizontal = this.direction === 'up' || this.direction === 'down';
                this.update();
            },

            update: function() {
                //this.target = this.isNext ? this.nextElementSibling : this.previousElementSibling;
                this.dimension = this.horizontal ? 'height' : 'width';
                this.classList.toggle('horizontal', this.horizontal);
            },

            targetChanged: function(old) {
                if (old) {
                    old.style[old.__splitterMinSize] = '';
                }
                //var min = this.target.__splitterMinSize = this.horizontal ? 'minHeight' : 'minWidth';
                //this.target.style[min] = this.minSize;
            },

            trackStart: function() {
                this.update();
                if (this.nextElementSibling) {
                    //this.nextElementSibling.setAttribute('flex', 'flex');
                    this.nextElementSiblingSize = parseInt(getComputedStyle(this.nextElementSibling)[this.dimension]);
                    //this.nextElementSibling.removeAttribute('flex');
                }
                if (this.previousElementSibling) {
                    //this.previousElementSibling.setAttribute('flex', 'flex');
                    this.previousElementSiblingSize = parseInt(getComputedStyle(this.previousElementSibling)[this.dimension]);
                    //this.previousElementSibling.removeAttribute('flex');
                }
            },
            track: function(e) {
                if (this.locked) {
                    return;
                }
                var d = e[this.horizontal ? 'dy' : 'dx'];
                if (this.nextElementSibling) {
                    this.nextElementSibling.style[this.dimension] = ( this.nextElementSiblingSize - d ) + 'px';
                }
                if (this.previousElementSibling) {
                    this.previousElementSibling.style[this.dimension] = ( this.previousElementSiblingSize + d ) + 'px';
                }
                //this.target.style[this.dimension] = this.size + (this.isNext ? -d : d) + 'px';
                //this.notifyResize();
            },
        });
    </script>
</polymer-element>
<polymer-element name="brt-dashboard-panel-proxy">
    <template>
        <style>
            :host{
                min-width: 100px;
                min-height: 100px;
                display: block;
            }
            #c{
                border: 2px dashed #dedede;
                background-color: #eeeeee;
                box-sizing: border-box;
                display: block;
            }
        </style>
        <div id="c"></div>
    </template>
    <script type="text/javascript">
        Polymer({
            isProxy: true,
            attached: function() {
                this.async(function(){
                    this.highlight('full');
                }, 100);
            },

            highlight: function(part){
                var box = this.getBoundingClientRect();
                var cs = this.$.c.style;
                switch(part){
                    case 'full':
                        cs.width = box.width+'px';
                        cs.height = box.height+'px';
                    break;
                    case 'left':
                        cs.width = (box.width /2)+'px';
                        cs.height = box.height+'px';
                    break;
                }
            }
        });
    </script>
</polymer-element>
<polymer-element name="brt-dashboard-column">
    <content></content>
    <script>
        Polymer('brt-dashboard-column', {
            splitterTagName: 'BRT-DASHBOARD-SPLITTER',
            observe: {
                'this.childNodes.length': 'onChildAddRemove'
            },

            updateWidth: function(){
                this.style.width = 'auto';
                this.style.width = this.getBoundingClientRect().width+'px';
            },

            onChildAddRemove: function() {
                this.onMutation(this, this.onChildAddRemove);
                this.removeSiblingIfEmpty();
            },

            removeSiblingIfEmpty: function(){
                var self = this;
                if (self.querySelectorAll('brt-panel').length == 0) {
                    var siblingColumn = false, siblingSpliter = false;
                    if (self.nextElementSibling && self.nextElementSibling.tagName == this.splitterTagName) {
                        siblingSpliter = self.nextElementSibling;
                    }
                    siblingColumn = siblingSpliter ? siblingSpliter.nextElementSibling : false;
                    if (self.previousElementSibling && self.previousElementSibling.tagName == this.splitterTagName) {
                        if (!siblingColumn) {
                            siblingColumn = self.previousElementSibling.previousElementSibling;
                        };

                        if(!siblingSpliter){
                            siblingSpliter = self.previousElementSibling;
                        }
                    };
                    //console.log('siblingSpliter', siblingSpliter, self.previousElementSibling, self.nextElementSibling)
                    siblingSpliter && siblingSpliter.remove();
                    self.remove();
                    if (siblingColumn && siblingColumn.tagName == this.tagName) {
                        //console.log('siblingColumn', siblingColumn, siblingColumn.parentNode, siblingColumn.parentNode.horizontal)
                        //if (siblingColumn.parentNode.horizontal) {
                            siblingColumn.updateWidth();
                        //}else{
                            //siblingColumn.style.height = 'auto';
                        //}
                    };
                }else{
                    /*self.async(function(){
                        self.updateWidth();
                    }, 10);*/
                }
            },

            attributeChanged: function(name, oldValue, newValue){

            },

            // Fires when an instance of the element is created
            created: function() {},

            attached: function(){
                /*this.async(function(){
                    this.updateWidth();
                }, 10);*/
            },

            // Fires when the element’s initial set of children and siblings are guaranteed to exist
            domReady: function() {
                this.onMutation(this, this.onChildAddRemove);
            }
        });
    </script>
</polymer-element>

<polymer-element name="brt-dashboard">
    <template>
        <style>
            :host{
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
            ::content brt-dashboard-column{
                /*display: block;*/
                overflow: auto !important;
            }
            ::content brt-panel, ::content brt-dashboard-panel-proxy{
                margin: 5px;
            }
            ::content brt-dashboard-splitter{
                width: 5px;
                min-width: 5px;
                min-height: 5px;
                /*opacity:0;*/
            }
            ::content brt-dashboard-splitter:hover, ::content brt-dashboard-splitter:active{
                opacity:1;
            }
            ::content brt-dashboard-splitter.horizontal{
                height: 5px;
                width: auto;
            }
        </style>
        <div id="container" horizontal layout>
            <content></content>
        </div>
    </template>
    <script>
    (function() {
        var proxy;
        function getStyle(elem,prop){
            if (elem.currentStyle) {
                var res= elem.currentStyle.margin;
            } else if (window.getComputedStyle) {
                if (window.getComputedStyle.getPropertyValue){
                    var res= window.getComputedStyle(elem, null).getPropertyValue(prop)
                }else{
                    var res =window.getComputedStyle(elem)[prop];
                };
            }
            return res;
        }
        Polymer('brt-dashboard', {
            // Fires when an instance of the element is created
            created: function() {
                if (!proxy) {
                    proxy = document.createElement('brt-dashboard-panel-proxy');
                };
            },

            // Fires when the element’s initial set of children and siblings are guaranteed to exist
            domReady: function() {
            },

            // Fires when the "<polymer-element>" has been fully prepared
            ready: function() {},

            // Fires when the element was inserted into the document
            attached: function() {
                this.addEventListener('drag-start', this.onPanelDragStart.bind(this))
            },

            onPanelDragStart: function(ce){
                //console.log('onPanelDragStart', ce.detail)
                var target = ce.target, column = target.parentNode, createSplitter = false;
                var targetBox = target.getBoundingClientRect();
                //proxy.style.width = targetBox.width+'px';
                //proxy.style.height = targetBox.height+'px';
                column.insertBefore(proxy, target);
                //this.async(function(){
                    target.style._display = target.style.display;
                    target.style.display = 'none';
                //}, null, 10);

                ce.detail.drag = function(dragInfo){
                    var info = this.findPanelByPos({x: dragInfo.event.clientX, y: dragInfo.event.clientY});
                    if (info) {
                        var panel = info.panel, isProxy = info.extra.isProxy, isHorizontal = panel.parentNode.hasAttribute('horizontal');
                        if (!isProxy) {
                            if ( (isHorizontal && info.extra.left) || (!isHorizontal && info.extra.top) ) {//create new splitter
                                panel.parentNode.insertBefore(proxy, panel);
                            }else{
                                panel.parentNode.insertBefore(proxy, panel.nextSibling);
                            }
                        }else{
                            if (info.extra.left) {//create new splitter
                                createSplitter = true;
                                proxy.highlight('left');
                            }else{
                                createSplitter = false;
                                proxy.highlight('full');
                            }
                        }
                    };
                }.bind(this)

                ce.detail.drop = function(dragInfo){
                    target.style.display = target.style._display;
                    
                    if (createSplitter) {
                        var splitter = document.createElement('brt-dashboard-splitter');
                        //splitter.setAttribute('direction', 'left');
                        var newColumn = document.createElement('brt-dashboard-column');
                        var proxyParent = proxy.parentNode;
                        var halfWidth   = proxyParent.getBoundingClientRect().width/2;

                        newColumn.style.width   = halfWidth + 'px';
                        proxyParent.style.width = halfWidth + 'px';
                        //newColumn.setAttribute('layout', 'layout');
                        newColumn.appendChild(target);
                        proxyParent.parentNode.insertBefore(newColumn, proxyParent);
                        proxyParent.parentNode.insertBefore(splitter, proxyParent);
                    }else{
                        proxy.parentNode.insertBefore(target, proxy);
                    }
                    
                    proxy.remove();
                }
            },

            findPanelByPos: function(pos){
                var panels = this.querySelectorAll('brt-panel,brt-dashboard-panel-proxy'), len = panels.length, p, w;
                for(var i=0; i< len; i++){
                    p = panels[i];
                    if(w = this.isPanelIntersect(p, pos, true)){
                        return {panel: p, extra: w};
                    }
                }
                return false;
            },

            isPanelIntersect: function(panel, pos, findExtraInfo){
                var box = panel.getBoundingClientRect();
                var x = pos.x, y = pos.y;
                console.log('box.top', box.top, y)
                var intersect = (box.left <= x && x <= box.right && box.top <= y && y <= box.bottom)
                if (!intersect || !findExtraInfo) {
                    return intersect;
                };
                var res = {isProxy: panel.isProxy};
                var w = box.width/3;
                var h = box.height/3;
                var x1 = box.left, x2 = x1+w, x3 = x2 + w;
                var y1 = box.top, y2 = y1+h, y3 = y2 + h;
                res.left = (x1 <= x && x <= x2);
                if (!res.left) {
                    res.center = (x2 <= x && x <= x3);
                    if (!res.center){
                        res.right = true;
                    }
                };

                res.top = (y1 <= y && y <= y2);
                if (!res.top) {
                    res.middle = (y2 <= y && y <= y3);
                    if (!res.middle){
                        res.bottom = true;
                    }
                };

                return res;
            },

            // Fires when the element was removed from the document
            detached: function() {},

            // Fires when an attribute was added, removed, or updated
            attributeChanged: function(attr, oldVal, newVal) {},

            add: function(panel){
                var columns = this.querySelectorAll('brt-dashboard-column');
                if (!columns.length) {
                    var column = document.createElement('brt-dashboard-column');
                        //column.setAttribute('horizontal', 'horizontal');
                        //column.setAttribute('layout', 'layout');
                    column.style.width = this.getBoundingClientRect().width+'px';
                    this.appendChild(column);
                }else{
                    column = columns[0];
                }

                column.appendChild(panel)
            }
        });
    })();
    </script>

</polymer-element>
